{
  "üî¥ ESTADO_CR√çTICO": {
    "timestamp": "2025-07-09T16:38:51.728686",
    "session_id": "20250709_sphere_restoration_architecture_documented",
    "project": "trajectory_hub",
    "version": "0.87",
    "status": "Sistema restaurado sin sphere, arquitectura documentada",
    "‚ö†Ô∏è ADVERTENCIA": [
      "EL SISTEMA NO RESPETA LA ARQUITECTURA IDEAL",
      "FIXES TEMPORALES HASTA REFACTORIZACI√ìN COMPLETA",
      "SIEMPRE CARGAR ESTE DOCUMENTO PRIMERO"
    ]
  },
  "üèóÔ∏è ARQUITECTURA_ACTUAL": {
    "descripci√≥n": "Arquitectura monol√≠tica con violaciones m√∫ltiples",
    "flujo_actual": {
      "1": "Usuario selecciona crear macro en CLI/Interactive",
      "2": "CLI llama DIRECTAMENTE a Engine.create_macro() ‚ùå",
      "3": "Engine recibe 'formation' string y calcula internamente ‚ùå",
      "4": "Engine calcula posiciones (deber√≠a solo aplicarlas) ‚ùå",
      "5": "Engine env√≠a a OSC Bridge",
      "6": "OSC Bridge env√≠a a Spat"
    },
    "responsabilidades_actuales": {
      "CLI_Interface": {
        "hace": [
          "Muestra men√∫s",
          "Captura input",
          "Llama a Engine directamente"
        ],
        "problemas": [
          "NO usa CommandProcessor",
          "Acceso directo a Engine"
        ]
      },
      "Interactive_Controller": {
        "hace": [
          "TODO - 122 m√©todos",
          "UI + L√≥gica + Procesamiento"
        ],
        "problemas": [
          "Monol√≠tico",
          "Deber√≠a tener m√°x 25 m√©todos"
        ]
      },
      "Engine": {
        "hace": [
          "Crea macros",
          "CALCULA formaciones",
          "Gestiona sources",
          "Env√≠a OSC"
        ],
        "problemas": [
          "NO deber√≠a calcular formaciones",
          "Demasiadas responsabilidades"
        ]
      },
      "FormationManager": {
        "hace": [
          "Calcula formaciones correctamente"
        ],
        "problemas": [
          "NO es usado por el flujo principal"
        ]
      },
      "CommandProcessor": {
        "hace": [
          "Existe pero no se usa en flujo principal"
        ],
        "problemas": [
          "Bypassed por CLI"
        ]
      }
    },
    "problemas_cr√≠ticos": [
      "Engine calcula formaciones en lugar de recibirlas",
      "CLI no usa CommandProcessor",
      "FormationManager existe pero no se integra",
      "Interactive Controller es monol√≠tico"
    ]
  },
  "üéØ ARQUITECTURA_DESEADA": {
    "descripci√≥n": "Arquitectura por capas con separaci√≥n estricta",
    "flujo_correcto": {
      "1": "Usuario interact√∫a con UI (CLI/Interactive/MCP/Gestos)",
      "2": "UI crea SemanticCommand con intenci√≥n",
      "3": "CommandProcessor interpreta comando",
      "4": "CommandProcessor usa FormationManager para calcular",
      "5": "CommandProcessor pasa positions[] a Engine",
      "6": "Engine SOLO aplica positions y env√≠a OSC",
      "7": "UI muestra resultado"
    },
    "responsabilidades_estrictas": {
      "UI_Layer": {
        "incluye": [
          "CLI_Interface",
          "Interactive_Controller",
          "MCP_Server",
          "Gesture_Handler"
        ],
        "responsabilidades": [
          "SOLO captura input",
          "SOLO muestra output",
          "Crea SemanticCommands"
        ],
        "prohibido": [
          "L√≥gica de negocio",
          "C√°lculos",
          "Acceso directo a Engine"
        ]
      },
      "Command_Layer": {
        "incluye": [
          "CommandProcessor",
          "IntentionParser"
        ],
        "responsabilidades": [
          "TODA la l√≥gica de negocio",
          "Interpretaci√≥n sem√°ntica",
          "Orquestaci√≥n"
        ],
        "prohibido": [
          "UI",
          "C√°lculos directos",
          "Comunicaci√≥n OSC"
        ]
      },
      "Calculation_Layer": {
        "incluye": [
          "FormationManager",
          "TrajectoryCalculator",
          "ModulationEngine"
        ],
        "responsabilidades": [
          "C√°lculos matem√°ticos",
          "Algoritmos",
          "Transformaciones"
        ],
        "prohibido": [
          "L√≥gica de negocio",
          "UI",
          "Estado"
        ]
      },
      "Execution_Layer": {
        "incluye": [
          "Engine",
          "OSC_Bridge"
        ],
        "responsabilidades": [
          "Aplicar estados",
          "Comunicaci√≥n externa",
          "Gesti√≥n de sources"
        ],
        "prohibido": [
          "C√°lculos",
          "L√≥gica de negocio",
          "UI"
        ]
      }
    },
    "principios_arquitect√≥nicos": [
      "SEPARACI√ìN DE RESPONSABILIDADES: Cada capa una funci√≥n",
      "FLUJO UNIDIRECCIONAL: UI ‚Üí Command ‚Üí Calc ‚Üí Execution",
      "INMUTABILIDAD: Estados no se modifican, se reemplazan",
      "TESTABILIDAD: Cada capa independently testeable",
      "EXTENSIBILIDAD: Nuevas features sin tocar capas existentes"
    ]
  },
  "üîß INSTRUCCIONES_SPHERE": {
    "problema_actual": "Engine usa _calculate_circle para sphere, resultando en 2D",
    "soluci√≥n_temporal": {
      "descripci√≥n": "Hacer que Engine use FormationManager para sphere",
      "pasos": [
        "1. A√±adir import FormationManager en Engine",
        "2. A√±adir caso elif formation == 'sphere'",
        "3. Delegar c√°lculo a FormationManager",
        "4. Verificar que OSC env√≠e x,y,z"
      ],
      "c√≥digo": "\nelif formation == \"sphere\":\n    # Soluci√≥n temporal - Engine usa FormationManager\n    if not hasattr(self, '_fm'):\n        self._fm = FormationManager()\n    positions = self._fm.calculate_formation(\"sphere\", self.config['n_sources'])\n    print(f\"üåê Sphere 3D: {len(positions)} posiciones calculadas\")\n"
    },
    "soluci√≥n_correcta": {
      "descripci√≥n": "Refactorizar para que Engine reciba positions",
      "requiere": "Implementaci√≥n completa del CommandProcessor",
      "beneficios": [
        "Separaci√≥n de responsabilidades",
        "F√°cil a√±adir formaciones",
        "Testeable"
      ]
    }
  },
  "üìä M√âTRICAS_ESTADO": {
    "funcionalidades": {
      "formaciones_2D": "5/5 ‚úÖ",
      "formaciones_3D": "0/1 ‚ùå (sphere pendiente)",
      "osc_comunicaci√≥n": "100% ‚úÖ",
      "sistema_deltas": "100% ‚úÖ"
    },
    "arquitectura": {
      "separaci√≥n_responsabilidades": "20% ‚ùå",
      "uso_command_processor": "10% ‚ùå",
      "modularidad": "30% ‚ùå",
      "testabilidad": "25% ‚ùå"
    },
    "deuda_t√©cnica": {
      "interactive_controller_m√©todos": "122 (objetivo: 25)",
      "engine_responsabilidades": "4 (objetivo: 2)",
      "flujo_directo_ui_engine": "S√≠ (objetivo: No)"
    }
  },
  "üõ£Ô∏è ROADMAP_MIGRACI√ìN": {
    "fase_0_actual": {
      "nombre": "Fixes temporales",
      "estado": "En progreso",
      "tareas": [
        "Sphere con FormationManager en Engine",
        "Mantener funcionalidad"
      ]
    },
    "fase_1": {
      "nombre": "Implementar CommandProcessor",
      "duraci√≥n": "1 semana",
      "tareas": [
        "Crear SemanticCommand class",
        "Implementar IntentionParser",
        "Conectar CLI ‚Üí CommandProcessor"
      ]
    },
    "fase_2": {
      "nombre": "Refactorizar Engine",
      "duraci√≥n": "3-4 d√≠as",
      "tareas": [
        "Engine.create_macro recibe positions[]",
        "Eliminar c√°lculos de Engine",
        "Usar solo FormationManager"
      ]
    },
    "fase_3": {
      "nombre": "Reducir InteractiveController",
      "duraci√≥n": "1 semana",
      "tareas": [
        "Extraer l√≥gica a CommandProcessor",
        "Dejar solo UI (25 m√©todos)",
        "Crear tests"
      ]
    },
    "fase_4": {
      "nombre": "Implementar MCP + Gestos",
      "duraci√≥n": "2 semanas",
      "tareas": [
        "MCP Server",
        "Gesture Handler",
        "Timeline Engine"
      ]
    }
  },
  "‚ö†Ô∏è REGLAS_INMUTABLES": [
    "1. Engine NUNCA debe calcular formaciones, solo aplicar positions",
    "2. TODO input debe pasar por CommandProcessor",
    "3. InteractiveController m√°ximo 25 m√©todos",
    "4. FormationManager solo calcula, no ejecuta",
    "5. OSC Bridge solo transmite, no procesa",
    "6. UI nunca accede directamente a Engine"
  ],
  "üíæ ARCHIVOS_CLAVE": {
    "documentaci√≥n": [
      "PROJECT_DNA_IMMUTABLE.json - ADN completo del proyecto",
      "PROJECT_STRUCTURE_ANALYSIS.json - An√°lisis arquitect√≥nico",
      "SESSION_STATE_*.json - Estados de sesi√≥n"
    ],
    "configuraci√≥n": [
      "trajectory_hub/config.py - Configuraci√≥n general",
      "docs/ARQUITECTURA_VISIONARIA.md - Visi√≥n futura"
    ],
    "para_modificar": {
      "sphere": "trajectory_hub/core/enhanced_trajectory_engine.py",
      "formaciones": "trajectory_hub/control/managers/formation_manager.py",
      "osc": "trajectory_hub/core/spat_osc_bridge.py"
    }
  },
  "üö® ESTADO_ACTUAL_SISTEMA": {
    "funciona": true,
    "sphere_implementado": false,
    "errores_conocidos": [
      "Sistema no arranca si se a√±ade sphere incorrectamente",
      "Import FormationManager debe ir con otros imports trajectory_hub"
    ],
    "√∫ltimo_backup_funcional": "enhanced_trajectory_engine.py.backup_macro_fix_20250708_093056"
  },
  "üìù NOTAS_PR√ìXIMA_SESI√ìN": [
    "CARGAR PROJECT_DNA_IMMUTABLE.json PRIMERO",
    "Verificar estado con diagnose_current_state.py",
    "NO hacer cambios autom√°ticos sin entender contexto",
    "Sphere debe a√±adirse manualmente siguiendo instrucciones",
    "Considerar iniciar Fase 1 del roadmap (CommandProcessor)"
  ],
  "üéØ COMANDOS_√öTILES": {
    "verificar_sistema": "python -m trajectory_hub.interface.interactive_controller",
    "test_formaciones": "python check_sphere_helper.py",
    "ver_estructura": "cat PROJECT_DNA_IMMUTABLE.json",
    "diagnosticar": "python diagnose_current_state.py"
  },
  "üß¨ PROJECT_DNA_EMBEDDED": {
    "üß¨ TRAJECTORY_HUB_DNA_v2": {
      "version": "2.0",
      "fecha": "2025-07-09T16:16:50.574251",
      "inmutable": true,
      "‚ö†Ô∏è INSTRUCCIONES_CRITICAS": [
        "ESTE DOCUMENTO ES LA VERDAD ABSOLUTA DEL PROYECTO",
        "DEBE SER LO PRIMERO QUE SE CARGUE EN CADA SESI√ìN",
        "NING√öN CAMBIO SIN ACTUALIZAR ESTE DOCUMENTO",
        "TODOS LOS FIXES DEBEN RESPETAR ESTA ARQUITECTURA"
      ],
      "üìä ESTADO_ACTUAL_REAL": {
        "flujo_creacion_macros": {
          "inicio": "CLI Interface",
          "pasos": [
            {
              "componente": "Engine",
              "accion": "Recibe create_macro con par√°metros",
              "detalles": "Par√°metros:          self,          name: str,          source_count: int,          behavior: str = \"flock\",         formation: str = \"circle\",         spacing: float = 2.0,         **kwargs     ) -> str:         # CORRECCI√ìN: Flexibilidad para source_count         if isinstance(source_count, list",
              "problema": "Recibe 'formation' y calcula internamente"
            },
            {
              "componente": "Engine",
              "accion": "Calcula formaciones internamente",
              "problema": "VIOLA arquitectura - deber√≠a solo aplicar posiciones"
            }
          ],
          "problemas": []
        },
        "responsabilidades": {
          "CLI Interface": {
            "metodos": 15,
            "responsabilidades": [
              "Muestra UI"
            ],
            "viola_arquitectura": []
          },
          "Interactive Controller": {
            "metodos": 39,
            "responsabilidades": [
              "Crea macros",
              "Muestra UI",
              "Procesa comandos"
            ],
            "viola_arquitectura": []
          },
          "Command Processor": {
            "metodos": 12,
            "responsabilidades": [
              "Crea macros"
            ],
            "viola_arquitectura": []
          },
          "Formation Manager": {
            "metodos": 1,
            "responsabilidades": [
              "Calcula formaciones"
            ],
            "viola_arquitectura": []
          },
          "Engine": {
            "metodos": 54,
            "responsabilidades": [
              "Crea macros",
              "Calcula formaciones",
              "Env√≠a OSC"
            ],
            "viola_arquitectura": [
              "No deber√≠a calcular formaciones"
            ]
          },
          "OSC Bridge": {
            "metodos": 52,
            "responsabilidades": [
              "Env√≠a OSC"
            ],
            "viola_arquitectura": []
          }
        }
      },
      "üéØ ESTADO_OBJETIVO": {
        "principios": [
          "SEPARACI√ìN ESTRICTA DE RESPONSABILIDADES",
          "FLUJO UNIDIRECCIONAL DE DATOS",
          "NING√öN COMPONENTE HACE TODO",
          "TESTABILIDAD COMPLETA"
        ],
        "flujo_correcto": {
          "1": "Usuario interact√∫a con UI (CLI/Interactive/MCP/Gestos)",
          "2": "UI crea SemanticCommand",
          "3": "CommandProcessor interpreta comando",
          "4": "CommandProcessor usa FormationManager para calcular",
          "5": "CommandProcessor pasa positions[] a Engine",
          "6": "Engine aplica positions y env√≠a OSC",
          "7": "UI muestra resultado"
        },
        "responsabilidades_estrictas": {
          "CLI Interface": [
            "Capturar input",
            "Mostrar output",
            "Crear comandos"
          ],
          "Interactive Controller": [
            "Navegaci√≥n men√∫s",
            "Display",
            "MAX 25 m√©todos"
          ],
          "Command Processor": [
            "TODA la l√≥gica",
            "Orquestar",
            "Validar"
          ],
          "Formation Manager": [
            "Calcular formaciones",
            "Nada m√°s"
          ],
          "Engine": [
            "Aplicar positions",
            "Gestionar sources",
            "Enviar OSC"
          ],
          "OSC Bridge": [
            "Comunicaci√≥n OSC",
            "Nada de l√≥gica"
          ]
        }
      },
      "‚ùå VIOLACIONES_ACTUALES": [
        {
          "tipo": "CR√çTICO",
          "componente": "Engine",
          "problema": "Calcula formaciones internamente en lugar de recibirlas",
          "impacto": "Imposible a√±adir formaciones sin modificar Engine",
          "solucion": "Engine.create_macro debe recibir positions[], no formation string"
        },
        {
          "tipo": "ALTO",
          "componente": "CLI Interface",
          "problema": "Llama directamente a Engine sin pasar por CommandProcessor",
          "impacto": "L√≥gica dispersa, dif√≠cil mantener",
          "solucion": "Todo debe pasar por CommandProcessor"
        },
        {
          "tipo": "MEDIO",
          "componente": "Interactive Controller",
          "problema": "122 m√©todos cuando deber√≠a tener m√°ximo 25",
          "impacto": "Dif√≠cil de mantener y testear",
          "solucion": "Refactorizar delegando l√≥gica a CommandProcessor"
        }
      ],
      "üõ†Ô∏è ROADMAP_MIGRACION": [
        {
          "fase": 1,
          "nombre": "Fix Sphere (temporal)",
          "tareas": [
            "Hacer que Engine use FormationManager para sphere",
            "Verificar que OSC env√≠e x,y,z"
          ],
          "tiempo": "30 minutos",
          "impacto": "BAJO"
        },
        {
          "fase": 2,
          "nombre": "Refactorizar create_macro",
          "tareas": [
            "Cambiar Engine.create_macro para recibir positions[]",
            "Mover c√°lculo de formaciones a CommandProcessor",
            "Actualizar todos los llamadores"
          ],
          "tiempo": "2-3 horas",
          "impacto": "ALTO"
        },
        {
          "fase": 3,
          "nombre": "Implementar CommandProcessor completo",
          "tareas": [
            "Crear SemanticCommand class",
            "Implementar interpretaci√≥n de comandos",
            "Conectar UI ‚Üí CommandProcessor ‚Üí Engine"
          ],
          "tiempo": "1 d√≠a",
          "impacto": "ALTO"
        },
        {
          "fase": 4,
          "nombre": "Refactorizar Interactive Controller",
          "tareas": [
            "Extraer l√≥gica a CommandProcessor",
            "Reducir a 25 m√©todos",
            "Solo navegaci√≥n y display"
          ],
          "tiempo": "2 d√≠as",
          "impacto": "MEDIO"
        }
      ],
      "üìã REGLAS_INMUTABLES": {
        "1": "Engine NUNCA calcula formaciones, solo aplica positions",
        "2": "TODO pasa por CommandProcessor",
        "3": "Interactive Controller m√°ximo 25 m√©todos",
        "4": "FormationManager solo calcula, no ejecuta",
        "5": "OSC Bridge solo transmite, no procesa"
      },
      "üîß PARA_ARREGLAR_SPHERE": {
        "problema": "Engine calcula sphere como circle (2D)",
        "solucion_temporal": "Hacer que Engine use FormationManager",
        "solucion_correcta": "Refactorizar flujo completo",
        "comando": "python fix_sphere_respecting_current_architecture.py"
      },
      "üíæ PRESERVAR_ENTRE_SESIONES": [
        "Este DNA completo",
        "Estado de refactorizaci√≥n",
        "Problemas pendientes",
        "Decisiones arquitect√≥nicas"
      ]
    }
  }
}